name: Build AmneziaWG for OpenWrt 25.12

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt tag (e.g., v25.12.0-rc5)'
        required: true
        type: string
        default: 'v25.12.0-rc5'
      target:
        description: 'Target'
        required: true
        type: string
        default: 'mediatek'
      subtarget:
        description: 'Subtarget'
        required: true
        type: string
        default: 'filogic'
      profile:
        description: 'Device profile (e.g., cudy_wr3000h-v1)'
        required: false
        type: string
        default: 'cudy_wr3000h-v1'

jobs:
  build:
    name: "Build AWG — ${{ inputs.target }}/${{ inputs.subtarget }}"
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3-setuptools python3-pyelftools \
            rsync swig unzip zlib1g-dev file wget zstd

      - name: Clone OpenWrt source tree
        run: |
          git clone --branch ${{ inputs.openwrt_version }} --single-branch --depth 1 \
            https://github.com/openwrt/openwrt.git openwrt
          cd openwrt

          # Add AmneziaWG feeds
          echo 'src-git amnezia https://github.com/amnezia-vpn/amneziawg-openwrt' >> feeds.conf.default
          echo 'src-git amnezialuci https://github.com/amnezia-vpn/amnezia-openwrt-luci' >> feeds.conf.default

      - name: Update feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Download official config for vermagic match
        working-directory: openwrt
        run: |
          # Use official config.buildinfo so kmod vermagic matches stock firmware
          VERSION="${{ inputs.openwrt_version }}"
          VERSION_NUM="${VERSION#v}"
          CONFIG_URL="https://downloads.openwrt.org/releases/${VERSION_NUM}/targets/${{ inputs.target }}/${{ inputs.subtarget }}/config.buildinfo"

          echo "Downloading config from: $CONFIG_URL"
          wget -O .config "$CONFIG_URL"

          # Append AmneziaWG packages as modules
          echo "CONFIG_PACKAGE_kmod-amneziawg=m" >> .config
          echo "CONFIG_PACKAGE_amneziawg-tools=m" >> .config
          echo "CONFIG_PACKAGE_luci-proto-amneziawg=m" >> .config

          make defconfig

      - name: Download sources
        working-directory: openwrt
        run: make download -j$(nproc) V=s

      # ── Cache: tools ──
      - name: Restore tools cache
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host
            openwrt/build_dir/host
            openwrt/build_dir/hostpkg
            openwrt/staging_dir/hostpkg
          key: tools-${{ inputs.openwrt_version }}-${{ inputs.target }}-${{ inputs.subtarget }}
          save-always: true

      - name: Build tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        working-directory: openwrt
        run: make tools/install -j$(nproc) V=s

      # ── Cache: toolchain ──
      - name: Restore toolchain cache
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ inputs.openwrt_version }}-${{ inputs.target }}-${{ inputs.subtarget }}
          save-always: true

      - name: Build toolchain
        if: steps.cache-toolchain.outputs.cache-hit != 'true'
        working-directory: openwrt
        run: make toolchain/install -j$(nproc) V=s

      # ── Cache: kernel ──
      - name: Restore kernel cache
        id: cache-kernel
        uses: actions/cache@v4
        with:
          path: |
            openwrt/build_dir/target-*/linux-*
            openwrt/staging_dir/target-*
          key: kernel-${{ inputs.openwrt_version }}-${{ inputs.target }}-${{ inputs.subtarget }}
          save-always: true

      - name: Build kernel
        if: steps.cache-kernel.outputs.cache-hit != 'true'
        working-directory: openwrt
        run: make target/linux/compile -j$(nproc) V=s

      - name: Fix luci-proto-amneziawg version for apk
        working-directory: openwrt
        run: |
          # PKG_VERSION:=0.0.1-1 produces "0.0.1-1-r1" which apk rejects.
          # Change to PKG_VERSION:=0.0.1 → apk gets valid "0.0.1-r1".
          LUCI_MK="feeds/amnezia/luci-proto-amneziawg/Makefile"
          if [ -f "$LUCI_MK" ]; then
            sed -i 's/^PKG_VERSION:=0\.0\.1-1$/PKG_VERSION:=0.0.1/' "$LUCI_MK"
            echo "Fixed luci-proto-amneziawg Makefile:"
            grep -E "PKG_VERSION|PKG_RELEASE" "$LUCI_MK" || true
          else
            echo "WARNING: $LUCI_MK not found, searching..."
            find feeds/ -path "*/luci-proto-amneziawg/Makefile" -exec \
              sed -i 's/^PKG_VERSION:=0\.0\.1-1$/PKG_VERSION:=0.0.1/' {} \; -print
          fi

      - name: Download kmod-amneziawg sources
        working-directory: openwrt
        run: |
          # First compile attempt downloads sources then fails on -Werror
          make package/kmod-amneziawg/compile -j$(nproc) V=s || true

      - name: Patch kmod-amneziawg for kernel 6.12 compatibility
        working-directory: openwrt
        run: |
          # Find the build dir with downloaded sources
          AWG_DIR=$(find build_dir/ -maxdepth 3 -name "kmod-amneziawg-*" -type d | head -1)

          if [ -z "$AWG_DIR" ]; then
            echo "ERROR: kmod-amneziawg build directory not found!"
            exit 1
          fi

          echo "Found AWG dir: $AWG_DIR"

          # Suppress -Werror=missing-prototypes and -Werror=missing-declarations
          # via ccflags-y (EXTRA_CFLAGS gets overridden by OpenWrt build system)
          if [ -f "$AWG_DIR/Makefile" ]; then
            sed -i 's/^ccflags-y := /ccflags-y := -Wno-missing-prototypes -Wno-missing-declarations /' "$AWG_DIR/Makefile"
            echo "Patched $AWG_DIR/Makefile:"
            head -3 "$AWG_DIR/Makefile"
          fi

      - name: Build AmneziaWG packages
        working-directory: openwrt
        run: |
          echo "=== Building kmod-amneziawg ==="
          make package/kmod-amneziawg/compile -j$(nproc) V=s

          echo "=== Building amneziawg-tools ==="
          make package/amneziawg-tools/compile -j$(nproc) V=s

          echo "=== Building luci-proto-amneziawg ==="
          make package/luci-proto-amneziawg/compile -j$(nproc) V=s

          echo "=== Build complete. Packages: ==="
          find bin/ -name "*amneziawg*" -o -name "*luci*amneziawg*" | head -20

      - name: Prepare release artifacts
        run: |
          mkdir -p awgrelease

          # Find and copy .apk packages (OpenWrt 25.12 format)
          find openwrt/bin/ -name "kmod-amneziawg*.apk" -exec cp {} awgrelease/ \;
          find openwrt/bin/ -name "amneziawg-tools*.apk" -exec cp {} awgrelease/ \;
          find openwrt/bin/ -name "luci-proto-amneziawg*.apk" -exec cp {} awgrelease/ \;
          find openwrt/bin/ -name "luci-i18n-amneziawg*.apk" -exec cp {} awgrelease/ \;

          echo "=== Release artifacts: ==="
          ls -la awgrelease/

          if [ -z "$(ls -A awgrelease/)" ]; then
            echo "ERROR: No packages found!"
            echo "Searching all bin/ for any built packages:"
            find openwrt/bin/ -type f -name "*.apk" | head -30
            find openwrt/bin/ -type f -name "*.ipk" | head -30
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: amneziawg-${{ inputs.target }}-${{ inputs.subtarget }}
          path: awgrelease/*

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: awgrelease/*
          tag_name: awg-${{ inputs.openwrt_version }}-${{ inputs.target }}-${{ inputs.subtarget }}
          name: "AmneziaWG for OpenWrt (${{ inputs.openwrt_version }}) — ${{ inputs.target }}/${{ inputs.subtarget }}"
          body: |
            AmneziaWG packages for OpenWrt ${{ inputs.openwrt_version }}
            - Target: ${{ inputs.target }}/${{ inputs.subtarget }}
            - Profile: ${{ inputs.profile }}

            Install on router:
            ```
            scp -O *.apk root@192.168.1.1:/tmp/
            ssh root@192.168.1.1
            cd /tmp
            apk add --allow-untrusted kmod-amneziawg*.apk
            apk add --allow-untrusted amneziawg-tools*.apk
            apk add --allow-untrusted luci-proto-amneziawg*.apk
            /etc/init.d/network restart
            ```
